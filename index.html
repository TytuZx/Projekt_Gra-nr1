<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Game Project1</title>
    <script src="http://127.0.0.1/Game-Project1/phaser-3.55.2/dist/phaser.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/phaser-raycaster@0.10.2/dist/phaser-raycaster.min.js"></script>
    

    <!-- <script src="phaser.min.js"></script> -->
    <script src="scripts/menu.js"></script>
    <script src="scripts/game.js"></script>

    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">


  let player; // ta zmienna to bedzie nasz gracz
  var cursors; // zmienna pomocnicza służąca do odczytu klawiszy 
  var playerSpeed = 5; // dodanie prędkości postaci
  let platform, lamp, background, light, door, sceneElements, key1, key2, key3, keyPhisics;
  var game;
  let counter = 100;


var Preloader = new Phaser.Class({     

    Extends: Phaser.Scene,

    initialize:

    

    function MainMenu () 
    {
        Phaser.Scene.call(this, { key: 'preloader' });
    },

    preload: function()
    {
        this.load.image('buttonStart', 'assets/PlayButton2.png');
        this.scene.start('stage1');
    }


})


var MainMenu = new Phaser.Class({  // komponent menu

    Extends: Phaser.Scene,

    initialize:

    function MainMenu () 
    {
        Phaser.Scene.call(this, { key: 'mainmenu' });
        window.MENU = this;
    },

    preload: function()
    {
        this.load.image('buttonStart', 'assets/PlayButton2.png');
        this.load.image('buttonQuit', 'assets/QuitButton2.png');

    },

    
    create:  function () 
    {
        var bs = this.add.image(800, 450, 'buttonStart');
        var bq = this.add.image(800, 550, 'buttonQuit');


        bs.setInteractive();

        bs.once('pointerup', function () {

            this.scene.start('intro');

        }, this);
    }

})

var Intro = new Phaser.Class({


    Extends: Phaser.Scene,

    initialize:

    function Intro () 
    {
        Phaser.Scene.call(this, { key: 'intro' });
        window.GAME = this;
    },

    preload: function() //ładowanie plików do gry (tekstury etc.)
    {
        this.load.image('groundp', 'assets/ground.png'); //ładowanie konkretnego pliku
        this.load.image('groundj', 'assets/ground.jpg');
    },


    
    create: function () 
    {

       this.add.text(500, 300, 'Stage1 \n\n\n obudziłeś sie w ciemnej jaskini, nie wiesz co się stało\n i jak się z niej wydostać\n\n\n naciśnij spację aby przejść dalej....', // wątek fabularny
       { fill: '#fff'
       });

       this.input.keyboard.on('keydown-SPACE', this.startStage1, this); // ustawienie nasłuchiwania na naciśnięcie spacji
    },

    startStage1: function () {   // funkcja która ładuję się po naciśnięciu spacji
        this.scene.start('stage1');
    },

}) 


var Stage1 = new Phaser.Class({  // poziom pierwszy gry

    Extends: Phaser.Scene,

    initialize:

    function Stage1 () 
    {
        Phaser.Scene.call(this, { key: 'stage1' });
    },
    

    preload: function() //ładowanie plików do gry (tekstury etc.)
    {
        cursors = this.input.keyboard.createCursorKeys(); // dodanie funkcji sterowania postacią
        platform = this.physics.add.staticGroup();
        keyPhisics = this.physics.add.staticGroup();
        
        sceneElementsStatic = this.physics.add.staticGroup();
       
       // game.physics.startSystem(Phaser.physics.ARCADE);


        this.load.image('groundp', 'assets/ground.png'); //ładowanie konkretnego pliku
        this.load.image('groundj', 'assets/ground.jpg');
        this.load.image('floor', 'assets/tile63.png'); 
        this.load.image('rightWall', 'assets/tile84.png');
        this.load.image('leftWall', 'assets/tile122.png');
        this.load.image('topWall', 'assets/tile46.png');
        this.load.image('door', 'assets/door1.png');
        this.load.image('lamp', ['assets/torch.png', 'assets/Solid_white.svg.png']);
        this.load.image('key', 'assets/key2.png');

    },
    
    create: function() //Funkcje ładowania rzeczy na ekran
    {
        function updateCounter1() {    // usuwanie klucza pierwszego, 
             counterKey--;
             counterText.setText('brakujące klucze:  ' + counterKey);
             console.log('cd');
             key1.disableBody(true, true); // usuwanie danego elementu
    };

    function updateCounter2() {    // usuwanie klucza drugirgo, 
             counterKey--;
             counterText.setText('brakujące klucze:  ' + counterKey);
             console.log('cd');
             key2.disableBody(true, true); // usuwanie danego elementu
    };

    function updateCounter3() {    // usuwanie klucza trzeciego, 
             counterKey--;
             counterText.setText('brakujące klucze:  ' + counterKey);
             console.log('cd');
             key3.disableBody(true, true); // usuwanie danego elementu
    };

        var i;
        background = this.add.image(100, 100, 'groundj');
        iwall = 26; //zmienne do ustawiania długości generowanych ścian i sufitów jako równe
        itop = 46;
        var counterKey = 3;
        
        this.lights.enable().setAmbientColor(0x000000);  // włączanie światła
        light = this.lights.addLight(380, 300, 300).setColor(0xffffff).setIntensity(1.4);
        counterText = this.add.text(1260, 50, 'brakujące klucze:  ' + counterKey, { fontSize: '32px', fill: '#999' });
       

        newDistance = 0;    // tworzenie lewej ściany
        for(i = 0; i<iwall; i++) {
            platform.create(20, 0 + newDistance, 'leftWall');
            newDistance += 35;
        }
        newDistance = 0;

        for(i = 0; i<iwall; i++) {  // tworzenie prawej ściany
            platform.create(1580, 0 + newDistance, 'rightWall');
            newDistance += 35;
        }

        newDistance = 0;  // tworzenie sufitu
        for(i = 0; i<itop; i++) {
            platform.create(0 + newDistance, -2, 'topWall');
            newDistance += 35;
        }
        var newDistance = 0;
        // platform.create(300, 100, 'groundp').setScale(2).refreshBody();
        for(i = 0; i<itop; i++) {  // tworzenie podłogi
            platform.create(0 + newDistance, 906, 'floor');
            newDistance += 35;
        }
        newDistance = 0;

        lamp = this.physics.add.sprite(400, 300, 'lamp');

        lightLamp = this.lights.addLight(380, 300, 300).setColor(0xffffff).setIntensity(0.5); // ustawienie światła dla lampy

        // lamp.setPipeline('Light2D');
        door = sceneElementsStatic.create(80, 436, 'door');
        door.setPipeline('Light2D');  // funkcja która sprawia, że drzwi działają ze światłem

        key1 = keyPhisics.create(100, 100, 'key');  // tworzenie klucza nr1
        key2 = keyPhisics.create(300, 100, 'key');  // tworzenie klucza nr1
        key3 = keyPhisics.create(500, 100, 'key');  // tworzenie klucza nr1

        key1.setPipeline('Light2D');
        key2.setPipeline('Light2D');
        key3.setPipeline('Light2D');



        player = this.physics.add.image(800, 450, 'groundp').setScale(0.3); // wczytanie bohatera w naszym przypadku aktualnie jest to kwadrat
        player.setCollideWorldBounds(true); // dodanie kolizji bohatera, z oknem
        

        background.setPipeline('Light2D'); // dodanie efektu światła na backgroundzie (przyciemnienie tła)

        this.physics.add.collider(platform, player);
        this.physics.add.collider(key1, player, updateCounter1, null, this);
        this.physics.add.collider(key2, player, updateCounter2, null, this);
        this.physics.add.collider(key3, player, updateCounter3, null, this);
  
  
    },

    update: function()
    {
       

        if(cursors.left.isDown){   // sterowanie postacią dla każdego klawisza
          //  player.x -= playerSpeed;
          player.setVelocityX(-500);
        } else {
            player.setVelocityX(0);
            player.setVelocityY(0);      
        }
        if(cursors.right.isDown){
            player.setVelocityX(500);

          //  player.x += playerSpeed;
        }
        if(cursors.up.isDown){
            player.setVelocityY(-500);

         //   player.y -= playerSpeed;
        }
        if(cursors.down.isDown){
            player.setVelocityY(500);

         //   player.y += playerSpeed;
        }

        light.x = player.x; // ustawienie światła w pozycji bohatera
        light.y = player.y;

   

    }
 
})

var config = {
        type: Phaser.WEBGL, //sposób renderowania grafiki
        width: 1600, //rozdzielczość
        height: 900,
        physics: { //fizyka, to jest do zmiany i ustalenia jaka będzie odpowiednia
            default: 'arcade',
            arcade: {
            gravity: { y: 0 },
            debug: false
            }
        },

        scene: [
         Preloader, MainMenu, Stage1, Intro
    ],
       
        plugins: {
        scene: [
            {
                key: 'PhaserRaycaster',
                plugin: PhaserRaycaster,
                mapping: 'raycasterPlugin'
            }
        ],
    }
    };



game = new Phaser.Game(config); //nie dokońca wiem po co to jest, do ustalenia

function preload ()
{
    
}


</script>

</body>
</html>